name: Security

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  GO_VERSION: "1.23"

jobs:
  gosec:
    name: Security Scan (gosec)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc sqlite3 libsqlite3-dev

      - name: Run gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif

  govulncheck:
    name: Vulnerability Check (govulncheck)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc sqlite3 libsqlite3-dev

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        env:
          CGO_ENABLED: 1
        run: govulncheck ./...

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  trivy-scan:
    name: Trivy Security Scanner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-fs-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-fs-results.sarif"
          category: "trivy-fs"

  docker-security:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: telephone:security-scan
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (Docker image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "telephone:security-scan"
          format: "sarif"
          output: "trivy-docker-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy Docker scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-docker-results.sarif"
          category: "trivy-docker"

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "telephone:security-scan"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"

  secrets-scan:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gosec, govulncheck, trivy-scan, docker-security, secrets-scan]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **gosec**: ${{ needs.gosec.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **govulncheck**: ${{ needs.govulncheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy Filesystem**: ${{ needs.trivy-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Security**: ${{ needs.docker-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secrets Scan**: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.gosec.result }}" != "success" ] || \
             [ "${{ needs.govulncheck.result }}" != "success" ] || \
             [ "${{ needs.trivy-scan.result }}" != "success" ] || \
             [ "${{ needs.docker-security.result }}" != "success" ] || \
             [ "${{ needs.secrets-scan.result }}" != "success" ]; then
            echo "⚠️ **Some security checks failed or found issues!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the security findings in the Security tab." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All security scans passed!**" >> $GITHUB_STEP_SUMMARY
          fi
