name: Code Coverage

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  GO_VERSION: "1.23"
  COVERAGE_THRESHOLD: 70

jobs:
  coverage:
    name: Code Coverage Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc sqlite3 libsqlite3-dev

      - name: Download Go modules
        run: go mod download

      - name: Run tests with coverage
        env:
          CGO_ENABLED: 1
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out -o=coverage.txt

      - name: Calculate coverage
        id: coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Current coverage: ${COVERAGE}%"
          echo "Threshold: ${{ env.COVERAGE_THRESHOLD }}%"

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Coverage $COVERAGE% is below threshold $THRESHOLD%"
            echo "Please add tests to improve coverage."
            exit 1
          else
            echo "‚úÖ Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

      - name: Generate coverage badge
        uses: tj-actions/coverage-badge-go@v2
        with:
          filename: coverage.out

      - name: Generate detailed coverage report
        run: |
          echo "## Code Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "**Total Coverage**: ${{ steps.coverage.outputs.coverage }}%" >> coverage-report.md
          echo "**Threshold**: ${{ env.COVERAGE_THRESHOLD }}%" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "### Coverage by Package" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "\`\`\`" >> coverage-report.md
          go tool cover -func=coverage.out >> coverage-report.md
          echo "\`\`\`" >> coverage-report.md

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const threshold = '${{ env.COVERAGE_THRESHOLD }}';
            const coverageFloat = parseFloat(coverage);
            const thresholdFloat = parseFloat(threshold);

            const emoji = coverageFloat >= thresholdFloat ? '‚úÖ' : '‚ùå';
            const status = coverageFloat >= thresholdFloat ? 'PASSED' : 'FAILED';

            // Read detailed coverage
            const detailedCoverage = fs.readFileSync('coverage.txt', 'utf8');
            const lines = detailedCoverage.split('\n');
            const packageCoverage = lines.filter(line => line.includes('%')).slice(0, -1);

            let tableRows = packageCoverage.map(line => {
              const parts = line.trim().split(/\s+/);
              const pkg = parts[0];
              const cov = parts[2];
              const covNum = parseFloat(cov.replace('%', ''));
              const pkgEmoji = covNum >= thresholdFloat ? '‚úÖ' : '‚ö†Ô∏è';
              return '| ' + pkgEmoji + ' ' + pkg + ' | ' + cov + ' |';
            }).join('\n');

            const warningMsg = coverageFloat < thresholdFloat ? '‚ö†Ô∏è **Warning**: Coverage is below the required threshold. Please add tests.' : '';

            const body = '## ' + emoji + ' Code Coverage Report\n\n' +
              '**Status**: ' + status + '\n' +
              '**Total Coverage**: ' + coverage + '%\n' +
              '**Threshold**: ' + threshold + '%\n\n' +
              '### Coverage by Package\n\n' +
              '| Package | Coverage |\n' +
              '|---------|----------|\n' +
              tableRows + '\n\n' +
              '<details>\n' +
              '<summary>üìä View Detailed Coverage</summary>\n\n' +
              '```\n' + detailedCoverage + '\n```\n\n' +
              '</details>\n\n' +
              warningMsg;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Code Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.out
            coverage.txt
            coverage-report.md
          retention-days: 30

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o=coverage.html

      - name: Upload HTML coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage.html
          retention-days: 30

  coverage-diff:
    name: Coverage Diff
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc sqlite3 libsqlite3-dev

      - name: Run tests on PR branch
        env:
          CGO_ENABLED: 1
        run: |
          go test -v -coverprofile=coverage-pr.out -covermode=atomic ./...
          COVERAGE_PR=$(go tool cover -func=coverage-pr.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "PR_COVERAGE=$COVERAGE_PR" >> $GITHUB_ENV

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Run tests on base branch
        env:
          CGO_ENABLED: 1
        run: |
          go test -v -coverprofile=coverage-base.out -covermode=atomic ./...
          COVERAGE_BASE=$(go tool cover -func=coverage-base.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "BASE_COVERAGE=$COVERAGE_BASE" >> $GITHUB_ENV

      - name: Calculate coverage diff
        id: diff
        run: |
          PR_COV=${{ env.PR_COVERAGE }}
          BASE_COV=${{ env.BASE_COVERAGE }}
          DIFF=$(echo "$PR_COV - $BASE_COV" | bc)
          echo "diff=$DIFF" >> $GITHUB_OUTPUT
          echo "Coverage diff: $DIFF%"

      - name: Comment coverage diff
        uses: actions/github-script@v7
        with:
          script: |
            const prCov = parseFloat('${{ env.PR_COVERAGE }}');
            const baseCov = parseFloat('${{ env.BASE_COVERAGE }}');
            const diff = parseFloat('${{ steps.diff.outputs.diff }}');

            let emoji = 'üìä';
            let status = 'No change';

            if (diff > 0) {
              emoji = 'üìà';
              status = 'Increased';
            } else if (diff < 0) {
              emoji = 'üìâ';
              status = 'Decreased';
            }

            const diffSign = diff > 0 ? '+' : '';
            const statusEmoji = diff > 0 ? '‚úÖ' : diff < 0 ? '‚ö†Ô∏è' : '‚ûñ';
            const warningMsg = diff < -1 ? '‚ö†Ô∏è **Warning**: This PR decreases coverage by more than 1%. Consider adding more tests.' : '';
            const successMsg = diff > 1 ? 'üéâ **Great job!** This PR increases test coverage.' : '';

            const body = '## ' + emoji + ' Coverage Comparison\n\n' +
              '| Branch | Coverage |\n' +
              '|--------|----------|\n' +
              '| Base (`' + context.payload.pull_request.base.ref + '`) | ' + baseCov + '% |\n' +
              '| PR (`' + context.payload.pull_request.head.ref + '`) | ' + prCov + '% |\n' +
              '| **Difference** | **' + diffSign + diff.toFixed(2) + '%** |\n\n' +
              '**Status**: ' + status + ' ' + statusEmoji + '\n\n' +
              warningMsg + successMsg;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Fail if coverage decreased significantly
        run: |
          DIFF=${{ steps.diff.outputs.diff }}
          if (( $(echo "$DIFF < -2" | bc -l) )); then
            echo "‚ùå Coverage decreased by more than 2%"
            echo "This is a significant drop. Please add tests."
            exit 1
          fi

  summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [coverage]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Check**: ${{ needs.coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.coverage.result }}" != "success" ]; then
            echo "‚ùå **Coverage check failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please improve test coverage to meet the threshold." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Coverage check passed!**" >> $GITHUB_STEP_SUMMARY
          fi
